<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="icon" href="/assets/images/favicon.png"><link rel="apple-touch-icon" href="/assets/images/apple-icon.png"><title>XCCacheAgent</title><link rel="preload" href="/assets/libraries/fontawesome/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="/assets/libraries/fontawesome/css/all.min.css"></noscript><link rel="preload" href="/assets/libraries/aos/aos.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="/assets/libraries/aos/aos.css"></noscript><!-- Non-Critical CSS--><link rel="stylesheet" href="/assets/libraries/bootstrap/css/bootstrap.min.css"><link rel="stylesheet" href="/assets/css/main.css"></head><body><header class="g-header"><div class="g-header__container"><div class="g-header__logo text-start"><a href="/"><img src="/assets/images/logo.png"></a><div class="g-header__hamburger-menu"><input class="d-none" id="hamburger-menu" type="checkbox"><label class="g-header__hamburger-menu__icon" for="hamburger-menu"><span></span></label></div></div><div class="g-header__search"><form class="g-search--box" action="#" method="POST"><input type="text" name="Search" placeholder="Search documentation..." required><button class="g-search--btn" type="submit" aria-label="Submit form"><svg data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 128 128"><path d="M81.69 4.75A41.556 41.556 0 0 0 49.586 72.7l-13 12.655-.6-.6a1.749 1.749 0 0 0-2.465-.012L5.894 111.9a1.75 1.75 0 0 0-.033 2.463l8.15 8.449a1.754 1.754 0 0 0 1.236.535h.023a1.748 1.748 0 0 0 1.227-.5l27.78-27.3a1.749 1.749 0 0 0 .012-2.484l-.772-.773 13.151-12.8A41.558 41.558 0 1 0 81.69 4.75zM15.3 119.113l-5.72-5.93 25.159-24.728 5.826 5.833zm23.759-31.285 12.865-12.522q.987 1.011 2.026 1.942L41.043 89.814zM81.69 84.37a38.173 38.173 0 0 1-24.043-8.556 39.314 39.314 0 0 1-4.36-4.17A38.061 38.061 0 1 1 81.69 84.37z"></path><path d="M81.69 10.75a35.56 35.56 0 0 0-26.547 59.22 36.7 36.7 0 0 0 4.082 3.905 35.187 35.187 0 0 0 22.465 8 35.56 35.56 0 0 0 0-71.12zm0 67.62a31.723 31.723 0 0 1-20.253-7.207 33.272 33.272 0 0 1-3.686-3.527A32.061 32.061 0 1 1 81.69 78.37z"></path></svg></button></form></div><div class="g-header__nav text-center"><nav class="g-nav"><a class="btn btn-primary rounded-pill px-3 py-2 fs-5" href="/download"><i class="fas fa-download me-2"></i>Download</a><a class="g-nav__link" href="/docs">Getting Started</a><a class="g-nav__link" href="/changelog">Changelog</a><a class="g-nav__link" href="/contact">Contact Us</a></nav></div></div></header><div class="g-main-container"><aside class="g-sidebar"><div class="g-sidebar__header"><h3>XCCacheAgent</h3></div><nav class="g-sidebar__nav"><ul class="g-nav-menu fw-medium"><li class="g-nav-menu__item g-nav-menu__item--has-submenu"><a class="g-nav-menu__link" href="#"><span class="icon">🚀</span><span class="text">Getting Started</span><span class="arrow"><i class="fa-solid fa-angle-down"></i></span></a><ul class="g-nav-submenu" style="max-height: 0"><li class="g-nav-submenu__item"><a class="g-nav-menu__link" href="/docs/quickstart">Quickstart</a></li><li class="g-nav-submenu__item"><a class="g-nav-menu__link" href="/docs/troubleshooting">Troubleshooting</a></li></ul></li><li class="g-nav-menu__item g-nav-menu__item--has-submenu open"><a class="g-nav-menu__link" href="#"><span class="icon">📚</span><span class="text">Knowledge Base</span><span class="arrow"><i class="fa-solid fa-angle-down"></i></span></a><ul class="g-nav-submenu" style="max-height: none"><li class="g-nav-submenu__item"><a class="g-nav-menu__link" href="/kb/packaging-as-xcframework">Packaging as XCFramework</a></li><li class="g-nav-submenu__item"><a class="g-nav-menu__link" href="/kb/ensuring-bundle-module">Ensuring Bundle Module</a></li><li class="g-nav-submenu__item"><a class="g-nav-menu__link" href="/kb/macro-as-binary">Macro as Binary</a></li><li class="g-nav-submenu__item"><a class="g-nav-menu__link" href="/kb/proxy-packages">Proxy Packages</a></li></ul></li><li class="g-nav-menu__item"><a class="g-nav-menu__link" href="/download"><span class="icon">📥</span><span class="text">Download </span></a></li><li class="g-nav-menu__item"><a class="g-nav-menu__link" href="/changelog"><span class="icon">📄</span><span class="text">Changelog</span></a></li><li class="g-nav-menu__item"><a class="g-nav-menu__link" href="/contact"><span class="icon">💬</span><span class="text">Contact Us</span></a></li></ul></nav></aside><main class="g-main-content"><div class="g-main-content__wrapper"><div class="g-hero-section mb-5"><div class="g-hero__container"><div class="g-hero__content"><h1 class="g-hero__title mb-3 me-auto">Ensuring Bundle Module</h1><div class="g-hero__subtitle me-auto"><p>Discover techniques to ensure proper bundle module structure</p></div></div></div></div><div class="content-section"><div class="container-fluid"><div class="row"><div class="col-12"><div class="content-section"><div class="row"><div class="col-lg-8"><h2>Accessing Resources in Code</h2><p>If a target includes resources, Xcode creates a resource bundle, which can be accessed using <code>Bundle.module</code>. This resource bundle is then copied to the app bundle:</p><pre class="bg-light p-3 rounded"><code>App.app
  |-- App (binary)
  |-- &lt;Pkg&gt;_&lt;Target&gt;.bundle</code></pre><div class="alert alert-warning mt-3"><i class="fas fa-exclamation-triangle me-2"></i><strong>Important: </strong>You are recommended to always use <code>Bundle.module</code> to access resources, and not make assumptions about the exact location of the resource bundle.<br>See: <a href="https://developer.apple.com/documentation/xcode/bundling-resources-with-a-swift-package#Access-a-resource-in-code" target="_blank" rel="noopener">Apple Documentation</a></div><h2 class="mt-4">How Bundle.module is Accessible</h2><p>For targets having resources, Xcode or SPM build system generates an internal code for the <code>Bundle.module</code> extension. More about SPM implementation for this: <a href="https://github.com/swiftlang/swift-evolution/blob/main/proposals/0271-package-manager-resources.md#runtime-access-to-resources-bundle" target="_blank" rel="noopener">read here</a>.</p><p>In Xcode, you can jump-to-definition on <code>Bundle.module</code> to see the generated code in a file called <code>resource_bundle_accessor.swift</code>. This file is later compiled (into an <code>.o</code> file) and merged into the library binary, along with other <code>.o</code> files.</p><div class="text-center mt-3"><img class="img-fluid" src="/assets/images/kb-resource-bundle-module.png"></div><p class="mt-3">With SPM (using <code>swift build</code>), you should see the generated source in <code>.build/debug/&lt;Target&gt;.build/DerivedSources</code>.</p><div class="text-center mt-3"><img class="img-fluid" src="/assets/images/kb-resource-build-structure.png"></div><h2 class="mt-4">Resource Bundle Inside xcframework</h2><p>With xccache, we want this resource bundle to reside inside the xcframework for convenience. However, when integrating this xcframework as a binary target. The app bundle structure looks like this:</p><pre class="bg-light p-3 rounded"><code>App.app
  |-- App (binary)
  |-- Frameworks
        |-- &lt;Target&gt;.framework
              |-- &lt;Target&gt; (binary)
              |-- &lt;Pkg&gt;_&lt;Target&gt;.bundle</code></pre><p><code>Bundle.module</code> can no longer detect the resource bundle. Note that the framework binary under <code>Frameworks/&lt;Target&gt;.framework/&lt;Target&gt;</code> is codeless. So, <code>Bundle(for: BundleFinder.self)</code> does not work either.</p><h2 class="mt-4">Workaround: Overriding Bundle Lookup Logic</h2><p>A workaround for this problem is to override the lookup logic. Before combining <code>.o</code> files into the framework binary (with <code>libtool</code>), we overwrite the object file <code>resource_bundle_accessor.swift.o</code> in the build directory.</p><p>This can be done by:</p><ol><li>First generating the source with the additional bundle lookup:<pre class="bg-light p-3 rounded mt-2"><code>...
let candidates = [
  Bundle.main.resourceURL,
  Bundle(for: BundleFinder.self).resourceURL,
  Bundle.main.bundleURL,
  // HERE 👇
  Bundle.main.bundleURL.appendingPathComponent("Frameworks/&lt;Target&gt;.framework")
]
...</code></pre></li><li>Compiling this file with <code>swiftc</code>, for example:</li></ol><pre class="bg-light p-3 rounded"><code>swiftc -emit-library \
  -module-name &lt;Foo&gt; \
  -target arm64-apple-ios-simulator \
  -sdk &lt;path/to/iPhoneSimulator.sdk&gt; \
  -o &lt;path/to/resource_bundle_accessor.swift.o&gt; \
  resource_bundle_accessor.swift</code></pre><div class="text-center mt-3"><img class="img-fluid" src="/assets/images/kb-resource-bundle-overriding.png"></div><p class="mt-3">The same logic applies to Objective-C, ie. generating <code>resource_bundle_accessor.m</code> and compiling it into <code>resource_bundle_accessor.m.o</code> using <code>clang</code>.</p></div><div class="col-lg-4"><div class="card border-0 bg-light"><div class="card-body"><h5 class="card-title mb-3"><i class="fas fa-book me-3"></i>Related Topics</h5><ul class="list-unstyled ms-0"><li class="mb-1"><a class="text-decoration-none" href="/kb/packaging-as-xcframework"><i class="fas fa-arrow-right me-3"></i>Packaging as XCFramework</a></li><li class="mb-1"><a class="text-decoration-none" href="/kb/ensuring-bundle-module"><i class="fas fa-arrow-right me-3"></i>Ensuring Bundle Module</a></li><li class="mb-1"><a class="text-decoration-none" href="/kb/macro-as-binary"><i class="fas fa-arrow-right me-3"></i>Macro as Binary</a></li><li class="mb-1"><a class="text-decoration-none" href="/kb/proxy-packages"><i class="fas fa-arrow-right me-3"></i>Proxy Packages</a></li></ul></div></div></div></div></div></div></div></div></div></div></main></div><footer class="g-footer"><div class="g-footer__container"><div class="g-footer__links"><a href="/contact">Contact Us</a><a href="/privacy">Privacy</a><a href="/terms">Terms</a></div><div class="g-footer__copyright"><p>Made by <a href="https://github.com/trinhngocthuyen"> Thuyen Trinh</a> with ❤️</p></div></div></footer><div class="g-mobile--overlay"></div><script src="/assets/libraries/aos/aos.js" defer></script><script src="/assets/js/main.js" defer></script></body></html>